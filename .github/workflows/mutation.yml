name: Mutation Testing

on:
  schedule:
    - cron: '0 4 * * 0' # Weekly on Sunday at 4 AM UTC
  workflow_dispatch: # Allow manual trigger
  pull_request:
    paths:
      - '**.go'
      - 'go.mod'
      - 'go.sum'

permissions:
  contents: read

jobs:
  mutation:
    name: Gremlins Mutation Testing
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Set up Go
        uses: actions/setup-go@4dc6199c7b1a012772edbd06daecab0f50c9053c # v6.1.0
        with:
          go-version-file: 'go.mod'
          cache: true

      - name: Install Gremlins
        run: |
          curl -sSL https://github.com/go-gremlins/gremlins/releases/download/v0.5.0/gremlins_0.5.0_linux_amd64.tar.gz | tar xz
          sudo mv gremlins /usr/local/bin/

      - name: Run Mutation Tests
        run: |
          # Use 2 workers to reduce memory pressure on GitHub Actions runner
          # Set per-mutation timeout to prevent hanging mutations
          gremlins unleash --tags="" --workers=2 --timeout=30s --output=mutation-report.json 2>&1 | tee mutation-output.txt
        continue-on-error: true
        timeout-minutes: 45

      - name: Upload Mutation Report
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
        with:
          name: mutation-report
          path: |
            mutation-report.json
            mutation-output.txt
          retention-days: 30

      - name: Summary
        run: |
          echo "## Mutation Testing Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f mutation-output.txt ]; then
            # Extract summary statistics
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            tail -20 mutation-output.txt >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "See the uploaded artifact for the full report." >> $GITHUB_STEP_SUMMARY
