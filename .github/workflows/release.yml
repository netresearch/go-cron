name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  test:
    name: Test before release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - name: Run tests
        run: go test -race -v ./...

  release:
    name: Create Release
    needs: test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get version from tag
        id: version
        run: echo "version=${GITHUB_REF#refs/tags/}" >> "$GITHUB_OUTPUT"

      - name: Generate changelog
        id: changelog
        run: |
          # Get the previous tag
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")

          if [ -z "$PREV_TAG" ]; then
            echo "First release - no previous tag found"
            COMMITS=$(git log --oneline --no-merges)
          else
            echo "Previous tag: $PREV_TAG"
            COMMITS=$(git log --oneline --no-merges "${PREV_TAG}..HEAD")
          fi

          # Format commits into categories
          FEATURES=$(echo "$COMMITS" | grep -E "^[a-f0-9]+ feat" || true)
          FIXES=$(echo "$COMMITS" | grep -E "^[a-f0-9]+ fix" || true)
          DOCS=$(echo "$COMMITS" | grep -E "^[a-f0-9]+ docs" || true)
          OTHER=$(echo "$COMMITS" | grep -vE "^[a-f0-9]+ (feat|fix|docs)" || true)

          # Build changelog
          {
            echo "changelog<<EOF"
            if [ -n "$FEATURES" ]; then
              echo "### Features"
              echo "$FEATURES" | sed -E 's/^[a-f0-9]+ feat(\([^)]*\))?[:(]?\s*/- /'
              echo ""
            fi
            if [ -n "$FIXES" ]; then
              echo "### Bug Fixes"
              echo "$FIXES" | sed -E 's/^[a-f0-9]+ fix(\([^)]*\))?[:(]?\s*/- /'
              echo ""
            fi
            if [ -n "$DOCS" ]; then
              echo "### Documentation"
              echo "$DOCS" | sed -E 's/^[a-f0-9]+ docs(\([^)]*\))?[:(]?\s*/- /'
              echo ""
            fi
            if [ -n "$OTHER" ]; then
              echo "### Other Changes"
              echo "$OTHER" | sed -E 's/^[a-f0-9]+\s+/- /'
              echo ""
            fi
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Generate SBOM
        uses: anchore/sbom-action@v0
        with:
          format: cyclonedx-json
          output-file: sbom.cyclonedx.json
          artifact-name: sbom-cyclonedx

      - name: Generate SPDX SBOM
        uses: anchore/sbom-action@v0
        with:
          format: spdx-json
          output-file: sbom.spdx.json
          artifact-name: sbom-spdx

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: ${{ steps.version.outputs.version }}
          body: |
            ## What's Changed

            ${{ steps.changelog.outputs.changelog }}

            ## Supply Chain Security

            This release includes Software Bill of Materials (SBOM) in both CycloneDX and SPDX formats for supply chain transparency and compliance.

            **Full Changelog**: https://github.com/${{ github.repository }}/compare/${{ steps.version.outputs.version }}...HEAD
          draft: false
          prerelease: ${{ contains(steps.version.outputs.version, '-') }}
          generate_release_notes: false
          files: |
            sbom.cyclonedx.json
            sbom.spdx.json
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
