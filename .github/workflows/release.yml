name: Release

on:
  push:
    tags:
      - 'v*'

permissions: read-all

jobs:
  test:
    name: Test before release
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@0634a2670c59f64b4a01f0f96f84700a4088b9f0 # v2.12.0
        with:
          egress-policy: audit

      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 0

      - name: Install Go
        uses: actions/setup-go@d35c59abb061a4a6fb18e82ac0862c26744d6ab5 # v5.5.0
        with:
          go-version-file: go.mod

      - name: Run tests
        run: go test -race -v ./...

  release:
    name: Create Release
    needs: test
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write  # Required for keyless signing
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@0634a2670c59f64b4a01f0f96f84700a4088b9f0 # v2.12.0
        with:
          egress-policy: audit

      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 0

      - name: Install Go
        uses: actions/setup-go@d35c59abb061a4a6fb18e82ac0862c26744d6ab5 # v5.5.0
        with:
          go-version-file: go.mod

      - name: Get version from tag
        id: version
        run: echo "version=${GITHUB_REF#refs/tags/}" >> "$GITHUB_OUTPUT"

      - name: Generate changelog
        id: changelog
        run: |
          # Get the previous tag
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")

          if [ -z "$PREV_TAG" ]; then
            echo "First release - no previous tag found"
            COMMITS=$(git log --oneline --no-merges)
          else
            echo "Previous tag: $PREV_TAG"
            COMMITS=$(git log --oneline --no-merges "${PREV_TAG}..HEAD")
          fi

          # Format commits into categories
          FEATURES=$(echo "$COMMITS" | grep -E "^[a-f0-9]+ feat" || true)
          FIXES=$(echo "$COMMITS" | grep -E "^[a-f0-9]+ fix" || true)
          DOCS=$(echo "$COMMITS" | grep -E "^[a-f0-9]+ docs" || true)
          OTHER=$(echo "$COMMITS" | grep -vE "^[a-f0-9]+ (feat|fix|docs)" || true)

          # Build changelog
          {
            echo "changelog<<EOF"
            if [ -n "$FEATURES" ]; then
              echo "### Features"
              echo "$FEATURES" | sed -E 's/^[a-f0-9]+ feat(\([^)]*\))?[:(]?\s*/- /'
              echo ""
            fi
            if [ -n "$FIXES" ]; then
              echo "### Bug Fixes"
              echo "$FIXES" | sed -E 's/^[a-f0-9]+ fix(\([^)]*\))?[:(]?\s*/- /'
              echo ""
            fi
            if [ -n "$DOCS" ]; then
              echo "### Documentation"
              echo "$DOCS" | sed -E 's/^[a-f0-9]+ docs(\([^)]*\))?[:(]?\s*/- /'
              echo ""
            fi
            if [ -n "$OTHER" ]; then
              echo "### Other Changes"
              echo "$OTHER" | sed -E 's/^[a-f0-9]+\s+/- /'
              echo ""
            fi
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Generate SBOM (CycloneDX)
        uses: anchore/sbom-action@e11c554f704a0b820cbf8c51673f6945e0731532 # v0.20.0
        with:
          format: cyclonedx-json
          output-file: sbom.cyclonedx.json
          artifact-name: sbom-cyclonedx

      - name: Generate SBOM (SPDX)
        uses: anchore/sbom-action@e11c554f704a0b820cbf8c51673f6945e0731532 # v0.20.0
        with:
          format: spdx-json
          output-file: sbom.spdx.json
          artifact-name: sbom-spdx

      - name: Generate checksums
        run: |
          sha256sum sbom.cyclonedx.json sbom.spdx.json > checksums.txt
          cat checksums.txt

      - name: Install Cosign
        uses: sigstore/cosign-installer@3454372f43399081ed03b604cb2d021dabca52bb # v3.8.2

      - name: Sign checksums with Cosign (keyless)
        run: |
          cosign sign-blob --yes \
            --output-certificate checksums.txt.pem \
            --output-signature checksums.txt.sig \
            checksums.txt

      - name: Verify signature
        run: |
          cosign verify-blob \
            --certificate checksums.txt.pem \
            --signature checksums.txt.sig \
            --certificate-identity-regexp "https://github.com/${{ github.repository }}/*" \
            --certificate-oidc-issuer "https://token.actions.githubusercontent.com" \
            checksums.txt

      - name: Create GitHub Release
        uses: softprops/action-gh-release@da05d552573ad5aba039eaac05058a918a7bf631 # v2.2.2
        with:
          name: ${{ steps.version.outputs.version }}
          body: |
            ## What's Changed

            ${{ steps.changelog.outputs.changelog }}

            ## Supply Chain Security

            This release includes:
            - **SBOM**: Software Bill of Materials in CycloneDX and SPDX formats
            - **Checksums**: SHA256 checksums for all artifacts
            - **Signatures**: Keyless Sigstore/Cosign signatures for verification

            ### Verify Release Integrity

            ```bash
            # Install cosign: https://docs.sigstore.dev/cosign/installation/

            # Download release artifacts
            gh release download ${{ steps.version.outputs.version }} -R ${{ github.repository }}

            # Verify checksums signature
            cosign verify-blob \
              --certificate checksums.txt.pem \
              --signature checksums.txt.sig \
              --certificate-identity-regexp "https://github.com/${{ github.repository }}/*" \
              --certificate-oidc-issuer "https://token.actions.githubusercontent.com" \
              checksums.txt

            # Verify file checksums
            sha256sum -c checksums.txt
            ```

            **Full Changelog**: https://github.com/${{ github.repository }}/compare/${{ steps.version.outputs.version }}...HEAD
          draft: false
          prerelease: ${{ contains(steps.version.outputs.version, '-') }}
          generate_release_notes: false
          files: |
            sbom.cyclonedx.json
            sbom.spdx.json
            checksums.txt
            checksums.txt.sig
            checksums.txt.pem
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
