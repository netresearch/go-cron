name: PR Quality Gates

on:
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened, ready_for_review]
  pull_request_review:
    types: [submitted]

permissions:
  contents: read
  pull-requests: write

jobs:
  quality-gate:
    name: Quality Gate
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' && github.event.pull_request.draft == false

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: audit

      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: PR Size Check
        uses: actions/github-script@f28e40c7f34bde8b3046d885e986cb6290c5673b # v7.1.0
        with:
          script: |
            const { data: files } = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
            });
            const total = files.reduce((sum, f) => sum + f.additions + f.deletions, 0);
            console.log(`PR Size: ${total} lines changed`);
            if (total > 1000) {
              core.warning(`Large PR with ${total} changes. Consider breaking into smaller PRs.`);
            }

  auto-approve:
    name: Auto-Approve (Solo Maintainer)
    runs-on: ubuntu-latest
    # No dependency on quality-gate â€” runs independently on both triggers
    # Only auto-approve non-draft PRs from the same repo (not forks)
    # Fork PRs require manual review by maintainer
    if: |
      github.event.pull_request.draft == false &&
      github.event.pull_request.head.repo.full_name == github.repository

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: audit

      - name: Check for pending reviewers
        id: check-reviewers
        uses: actions/github-script@f28e40c7f34bde8b3046d885e986cb6290c5673b # v7.1.0
        with:
          script: |
            const prNumber = context.payload.pull_request.number;
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber,
            });

            const pendingUsers = pr.requested_reviewers.map(r => r.login);
            const pendingTeams = pr.requested_teams.map(t => t.slug);
            const pending = [...pendingUsers, ...pendingTeams];

            if (pending.length > 0) {
              console.log(`Waiting for reviewers: ${pending.join(', ')}`);
              core.setOutput('ready', 'false');
              return;
            }

            // Check that no reviewer has requested changes
            const { data: reviews } = await github.rest.pulls.listReviews({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber,
            });
            // Build map of latest review state per reviewer
            const latestByReviewer = new Map();
            for (const review of reviews) {
              if (review.state === 'APPROVED' || review.state === 'CHANGES_REQUESTED') {
                latestByReviewer.set(review.user.login, review.state);
              }
            }
            const changesRequested = [...latestByReviewer.entries()]
              .filter(([, state]) => state === 'CHANGES_REQUESTED')
              .map(([login]) => login);

            if (changesRequested.length > 0) {
              console.log(`Changes requested by: ${changesRequested.join(', ')}`);
              core.setOutput('ready', 'false');
            } else {
              console.log('All assigned reviewers have completed their reviews');
              core.setOutput('ready', 'true');
            }

      - name: Auto-approve PR
        if: steps.check-reviewers.outputs.ready == 'true'
        uses: actions/github-script@f28e40c7f34bde8b3046d885e986cb6290c5673b # v7.1.0
        with:
          script: |
            const prNumber = context.payload.pull_request.number;

            // Don't double-approve
            const { data: reviews } = await github.rest.pulls.listReviews({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber,
            });
            const alreadyApproved = reviews.some(
              r => r.user.login === 'github-actions[bot]' && r.state === 'APPROVED'
            );
            if (alreadyApproved) {
              console.log('Already approved by automation, skipping');
              return;
            }

            await github.rest.pulls.createReview({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber,
              event: 'APPROVE',
              body: '**Automated approval for solo maintainer project**\n\nAll assigned reviewers have completed their reviews. See SECURITY.md for compensating controls.'
            });
